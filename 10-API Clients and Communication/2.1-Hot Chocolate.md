
Şimdi .NET dünyasında GraphQL denince akla gelen ilk ve en güçlü motoru, **Hot Chocolate** kütüphanesini masaya yatırıyoruz.

Bu sadece bir "kütüphane" değil, tam teşekküllü bir **GraphQL Platformudur.** Microsoft mühendisleri tarafından da desteklenen bu araç, "Schema Stitching", "Federation" ve "Projections" gibi ileri mühendislik yetenekleriyle doludur.

---

### 1. Felsefe: Code-First vs Schema-First

Hot Chocolate kullanırken vermen gereken ilk mimari karar şudur: Şemayı nasıl tanımlayacağım?

1. **Schema-First:** Önce `.graphql` dosyası açıp `type Author { ... }` diye yazarsın. Sonra bunu C# koduna bağlarsın (Bind).
    
    - _Avantaj:_ Frontend ve Backend ekipleri ortak dil (SDL) üzerinden anlaşır.
        
    - _Dezavantaj:_ C# modellerin değiştikçe şema dosyasını sürekli elle güncellemek ameleliktir.
        
2. **Code-First (Hot Chocolate'ın Gücü):** Sadece C# sınıflarını yazarsın. Hot Chocolate, çalışma zamanında (Runtime) bunlara bakarak GraphQL şemasını otomatik üretir.
    
    - _Avantaj:_ C# kodun "Single Source of Truth" (Tek Gerçeklik Kaynağı) olur. Refactoring kolaydır.
        
    - _Öneri:_ .NET projelerinde %95 **Code-First** tercih edilir.
        

---

### 2. Mimari: Resolver ve Pipeline

Hot Chocolate'ın kendi içinde ASP.NET Core Middleware'ine benzeyen bir Execution Pipeline'ı vardır.

Bir sorgu geldiğinde şu aşamalardan geçer:

1. **Parsing:** Gelen string sorgu analiz edilir.
    
2. **Validation:** İstenen alanlar şemada var mı? Tipler uyuyor mu?
    
3. **Operation Execution:** Resolver'lar çalıştırılır.
    

Banana Cake Pop (BCP):

Hot Chocolate kurduğunda, /graphql adresinde sana muazzam bir IDE (Banana Cake Pop) sunar. Postman kullanmana gerek kalmaz. Şemayı görselleştirir, dokümantasyonu gösterir ve sorgu yazarken "Intellisense" sağlar.

---

### 3. Mühendislik Harikası: `IQueryable` Projections

GraphQL'in en büyük vaadi "İstemci ne isterse onu ver" idi. Peki bunu veritabanına (SQL) nasıl yansıtacağız?

Hot Chocolate, Entity Framework Core ile korkutucu derecede iyi entegre olur.

Senaryo: Users tablosunda 50 sütun var. İstemci sadece Name istedi.

Standart Kod: SELECT * FROM Users (Tüm sütunları çeker, RAM'de Name'i ayıklar). (Verimsiz).

**Hot Chocolate (`UseProjection`):**

C#

```cs
[UseProjection] // Sihirli Attribute
[UseFiltering]
[UseSorting]
public IQueryable<User> GetUsers(AppDbContext context) => context.Users;
```

Sihir: Hot Chocolate, gelen GraphQL sorgusunu (query { users { name } }) analiz eder ve bunu EF Core Expression Tree'ye çevirir.

Oluşan SQL: SELECT Name FROM Users

Sadece istenen sütunu veritabanından çeker. Performans muazzamdır.

---

### 4. N+1 Çözücüsü: BatchDataLoader

Teorik olarak konuştuğumuz DataLoader desenini Hot Chocolate'ta uygulamak çok basittir.

BatchDataLoader sınıfından türeyen bir sınıf yazarsın. Bu sınıf List<int> ids alır.

Hot Chocolate, aynı anda gelen (milisaniyeler içindeki) tüm isteklerin ID'lerini toplar, bu sınıfa verir. Sen tek bir WHERE ID IN (...) sorgusu atarsın ve sonucu dönersin. Hot Chocolate sonuçları isteklere geri dağıtır.

---

### 5. Real-Time: Subscriptions (WebSockets)

Hot Chocolate, gerçek zamanlı veriyi (örn: "Bitcoin fiyatı değişti") istemciye itmek (Push) için **WebSockets** kullanır.

Mühendislik Detayı (Redis Backplane):

Eğer uygulaman tek bir sunucuda çalışıyorsa, In-Memory Subscription yeterlidir.

Ama uygulaman Kubernetes üzerinde 10 Pod (Sunucu) olarak çalışıyorsa?

- Sunucu A'daki bir değişikliği, Sunucu B'ye bağlı olan kullanıcı duyamaz.
    
- **Çözüm:** Hot Chocolate Redis Provider. Mesajlar Redis Pub/Sub üzerinden tüm sunuculara dağıtılır.
    

---

### 6. İleri Seviye: Schema Stitching & Federation

Microservices dünyasında her servisin (Ürün, Sipariş, Kullanıcı) kendi GraphQL API'si olabilir. Ama Frontend tek bir URL (`api.com/graphql`) ile konuşmak ister.

Hot Chocolate bu servisleri birleştirip tek bir dev şema (Gateway) sunabilir.

1. **Schema Stitching:** Eski yöntem. Gateway, diğer servislerin şemalarını indirir ve "diker".
    
2. **Apollo Federation:** Yeni standart. Her servis (Subgraph) "Benim şemam bu ve User tipini genişletiyorum" der. Gateway (Supergraph) bunları akıllıca yönetir. Hot Chocolate, .NET dünyasında Apollo Federation uyumlu tek sunucudur.
    

